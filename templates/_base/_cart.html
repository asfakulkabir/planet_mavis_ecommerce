<div id="sidebar-container">
    <!-- Toggle Button -->
    <button id="toggle-sidebar" class="fixed bottom-8 right-4 z-20 rounded-full bg-green-600 p-4 text-white focus-visible:outline-green-700 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.5" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"/>
        </svg>
    </button>

    <!-- Sidebar -->
    <nav id="sidebar" class="fixed right-0 top-0 z-50 h-full w-80 bg-white shadow-lg border-l border-gray-200 p-4 transition-transform duration-300" style="transform: translateX(100%);">
        <!-- Sidebar Header -->
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-medium text-gray-900">Your Cart</h3>
            <button id="close-sidebar" class="text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.5" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Cart Items -->
        <div id="cart-items" class="flex flex-col gap-2 overflow-y-auto py-4">
            <!-- Cart items will be dynamically inserted here -->
        </div>

        <!-- Sidebar Footer -->
        <div class="mt-auto border-t pt-4 w-ful" id="cart-action-buttons">
            <div class="flex items-center justify-between text-lg font-bold text-gray-900">
                <span>Total</span>
                <span id="total-price">৳0</span>
            </div>
            <div class="flex gap-2">
            <button id="clear-cart" class="mt-4 w-full bg-gray-600 text-white p-2 rounded hover:bg-gray-700">Clear Cart</button>
            <a href="{% url 'website:checkout_ecommerce' %}" class="mt-4 w-full bg-rose-800 text-white p-2 rounded hover:bg-rose-900 flex items-center text-center justify-center">Checkout</a>
            </div>
        </div>
    </nav>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    const toggleButton = document.getElementById("toggle-sidebar");
    const closeButton = document.getElementById("close-sidebar");
    const sidebar = document.getElementById("sidebar");
    const cartItemsContainer = document.getElementById("cart-items");
    const totalPriceElement = document.getElementById("total-price");
    const clearCartButton = document.getElementById("clear-cart");
    const cartActionButton = document.getElementById('cart-action-buttons');

    // Toggle sidebar open/close
    toggleButton.addEventListener("click", function () {
        sidebar.style.transform = sidebar.style.transform === "translateX(100%)" ? "translateX(0)" : "translateX(100%)";
        updateCartSidebar(); // Update the sidebar when opened
    });

    // Close sidebar
    closeButton.addEventListener("click", function () {
        sidebar.style.transform = "translateX(100%)";
    });
// Close sidebar when clicking anywhere outside of it (but not on the toggle button)
document.addEventListener("click", function (event) {
    const isClickInsideSidebar = sidebar.contains(event.target);
    const isClickOnToggleButton = toggleButton.contains(event.target);

    // If the click is outside the sidebar and not on the toggle button, close the sidebar
    if (!isClickInsideSidebar && !isClickOnToggleButton) {
        sidebar.style.transform = "translateX(100%)";
    }
});

// Prevent sidebar from closing when clicking the plus or minus buttons inside the sidebar
cartItemsContainer.addEventListener("click", function (event) {
    const target = event.target;
    if (target.classList.contains("increase-quantity") || target.classList.contains("decrease-quantity")) {
        event.stopPropagation(); // Prevent click from bubbling up to document
    }
});


    // Function to update the sidebar with cart items
    function updateCartSidebar() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        cartItemsContainer.innerHTML = ""; // Clear existing items

        // If the cart is empty, show a message
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<p class="text-center text-gray-600">Your cart is empty</p>';
            totalPriceElement.textContent = '৳0';
            cartActionButton.classList.add('hidden')
            return;
        }
        else {
            cartActionButton.classList.remove('hidden');
        }
        let total = 0;

        // Render each cart item
        cart.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;

            const itemHTML = `
                <div class="flex justify-between gap-4 py-4">
               <img src="${item.image ? item.image : '/static/icons/default-image.webp'}" class="size-20 object-cover rounded" alt="${item.name}"/>
                    <div class="mr-auto flex flex-col gap-2">
                        <p class="text-sm text-gray-900">${item.name}</p>
                        ${item.variation.color ? `<p class="text-xs text-gray-600">Color: ${item.variation.color}</p>` : ""}
                        ${item.variation.size ? `<p class="text-xs text-gray-600">Size: ${item.variation.size}</p>` : ""}
                        ${item.variation.weight ? `<p class="text-xs text-gray-600">Weight: ${item.variation.weight} kg</p>` : ""}

                        <div class="mt-2 flex items-center gap-2">
                            <button type="button" class="h-8 w-8 flex items-center justify-center rounded-md border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200 transition decrease-quantity" data-index="${index}" aria-label="Decrease Quantity">
                                -
                            </button>

                            <input type="text" class="w-10 h-8 text-center border border-gray-300 bg-white text-gray-700" value="${item.quantity}" readonly/>

                            <button type="button" class="h-8 w-8 flex items-center justify-center rounded-md border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200 transition increase-quantity" data-index="${index}" aria-label="Increase Quantity">
                                +
                            </button>
                        </div>
                    </div>
                    <p class="text-sm font-bold text-gray-900">৳${itemTotal.toFixed(2)}</p>
                </div>
            `;

            cartItemsContainer.insertAdjacentHTML("beforeend", itemHTML);
        });
        // Update total price
        totalPriceElement.textContent = `৳${total.toFixed(2)}`;

    }

    // Handle quantity updates in the sidebar
    cartItemsContainer.addEventListener("click", function (event) {
        const target = event.target;
        const index = target.dataset.index;

        if (target.classList.contains("decrease-quantity")) {
            updateCartItemQuantity(index, -1);
        } else if (target.classList.contains("increase-quantity")) {
            updateCartItemQuantity(index, 1);
        }
    });

    // Function to update cart item quantity
    function updateCartItemQuantity(index, change) {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const item = cart[index];

        if (item) {
            item.quantity += change;

            if (item.quantity <= 0) {
                cart.splice(index, 1); // Remove item if quantity is 0
            }

            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartSidebar(); // Refresh the sidebar
        }
    }

    // Clear Cart
    clearCartButton.addEventListener("click", function () {
        localStorage.removeItem("cart");
        updateCartSidebar(); // Refresh the sidebar
        location.reload(); 
    });

    // Initial update of the sidebar
    updateCartSidebar();
});
</script>
