{% extends '_base/_base.html' %}
{% block content %}
<h2 class="text-2xl font-bold mb-6">Add New Product</h2>

<form method="post" enctype="multipart/form-data" x-data="productForm()" @submit.prevent="submitForm" class="space-y-6">
  {% csrf_token %}

  <!-- Product Basic Info -->
  <div>
    <label for="name" class="block font-medium mb-1">Product Name</label>
    <input type="text" id="name" name="name" x-model="product.name" required
      class="border rounded px-3 py-2 w-full" />
  </div>

  <div>
    <label for="description" class="block font-medium mb-1">Description</label>
    <textarea id="description" name="description" x-model="product.description"
      class="border rounded px-3 py-2 w-full"></textarea>
  </div>

  <!-- Categories -->
  <div>
    <label class="block font-medium mb-1">Categories</label>
    <template x-for="category in categories" :key="category.id">
      <label class="inline-flex items-center mr-4 mb-2">
        <input type="checkbox" :value="category.id" name="categories" x-model="product.categories"
          class="form-checkbox" />
        <span class="ml-2" x-text="category.name"></span>
      </label>
    </template>
  </div>

  <!-- Prices and Stock -->
  <div class="grid grid-cols-2 gap-4">
    <div>
      <label for="regular_price" class="block font-medium mb-1">Regular Price</label>
      <input type="number" min="0" step="0.01" id="regular_price" name="regular_price" x-model="product.regular_price" required
        class="border rounded px-3 py-2 w-full" />
    </div>
    <div>
      <label for="sale_price" class="block font-medium mb-1">Sale Price</label>
      <input type="number" min="0" step="0.01" id="sale_price" name="sale_price" x-model="product.sale_price"
        class="border rounded px-3 py-2 w-full" />
    </div>
  </div>

  <div>
    <label for="stock_quantity" class="block font-medium mb-1">Stock Quantity</label>
    <input type="number" min="0" id="stock_quantity" name="stock_quantity" x-model="product.stock_quantity" required
      class="border rounded px-3 py-2 w-full" />
  </div>

  <!-- Images Section -->
  <div>
    <h3 class="font-semibold mb-2">Product Images</h3>
    <template x-for="(img, index) in images" :key="index">
      <div class="flex items-center space-x-4 mb-3">
        <div class="w-24 h-24 border rounded overflow-hidden bg-gray-100">
          <img :src="img.url || img.preview" alt="Image preview" class="object-cover w-full h-full" />
        </div>
        <input type="file" :name="'images-' + index" @change="previewImage($event, index)" />
        <button type="button" @click="removeImage(index)" class="text-red-600 font-semibold hover:text-red-800">
          Remove
        </button>
      </div>
    </template>
    <button type="button" @click="addImage()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">
      + Add Image
    </button>
  </div>

  <!-- Variations Section -->
  <div>
    <h3 class="font-semibold mb-2 mt-6">Product Variations</h3>
    <template x-for="(variation, idx) in variations" :key="idx">
      <div class="border p-4 mb-4 rounded flex flex-col md:flex-row md:space-x-6">
        <div class="flex-1 mb-3 md:mb-0">
          <label class="block font-medium mb-1">Attributes</label>
          <select multiple
                  :name="'variations-' + idx + '-attribute_values'"
                  x-model="variation.attribute_values"
                  class="border rounded px-2 py-1 w-full">
            <template x-for="attrValue in attributeValues" :key="attrValue.id">
              <option :value="attrValue.id" x-text="attrValue.display"></option>
            </template>
          </select>
        </div>
        <div class="w-32 mb-3 md:mb-0">
          <label class="block font-medium mb-1">Price</label>
          <input type="number" step="0.01" min="0" required
                 :name="'variations-' + idx + '-price'"
                 x-model="variation.price"
                 class="border rounded px-2 py-1 w-full" />
        </div>
        <div class="w-32 mb-3 md:mb-0">
          <label class="block font-medium mb-1">Stock Qty</label>
          <input type="number" min="0" required
                 :name="'variations-' + idx + '-stock_quantity'"
                 x-model="variation.stock_quantity"
                 class="border rounded px-2 py-1 w-full" />
        </div>
        <div class="flex items-center mt-4 md:mt-0">
          <button type="button" @click="removeVariation(idx)" class="text-red-600 hover:text-red-800 font-semibold px-3 py-1 rounded border border-red-600">
            Remove
          </button>
        </div>
      </div>
    </template>
    <button type="button" @click="addVariation()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">
      + Add Variation
    </button>
  </div>

  <!-- Submit Button -->
  <div>
    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition">
      Add Product
    </button>
  </div>
</form>

<script>
  function productForm() {
    return {
      product: {
        name: '',
        description: '',
        categories: [],
        regular_price: '',
        sale_price: '',
        stock_quantity: '',
      },
      categories: {{ categories|safe }},
      images: [],
      variations: [
        { attribute_values: [], price: '', stock_quantity: '' },
      ],
      attributeValues: {{ attribute_values|safe }},

      addImage() {
        this.images.push({ file: null, preview: '' });
      },
      removeImage(index) {
        this.images.splice(index, 1);
      },
      previewImage(event, index) {
        const file = event.target.files[0];
        if (!file) return;
        this.images[index].file = file;
        const reader = new FileReader();
        reader.onload = e => {
          this.images[index].preview = e.target.result;
        };
        reader.readAsDataURL(file);
      },

      addVariation() {
        this.variations.push({ attribute_values: [], price: '', stock_quantity: '' });
      },
      removeVariation(index) {
        this.variations.splice(index, 1);
      },

      submitForm() {
        // Because file inputs are not bindable via x-model,
        // and this is a demo, simply submit the form normally here.
        // You can add validations before submitting if needed.
        this.$root.submit();
      }
    }
  }
</script>

{% endblock %}
